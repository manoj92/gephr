require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")
require File.join(File.dirname(`node --print "require.resolve('@react-native-community/cli-platform-ios/package.json')"`), "native_modules")

platform :ios, min_ios_version_supported
prepare_react_native_project!

# Enable Flipper for development builds
flipper_config = ENV['NO_FLIPPER'] == "1" ? FlipperConfiguration.disabled : FlipperConfiguration.enabled

# Enable Hermes engine for better performance
use_hermes = true

target 'GephrLabsHumanoidTrainingPlatform' do
  config = use_native_modules!

  # Native React Native setup
  use_react_native!(
    :path => config[:reactNativePath],
    # Enable Hermes engine
    :hermes_enabled => use_hermes,
    # Flipper development tools
    :flipper_configuration => flipper_config,
    # App root path
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  # Camera permissions for hand tracking
  pod 'Permission-Camera', :path => "../node_modules/react-native-permissions/ios/Camera"
  
  # Location permissions for mapping
  pod 'Permission-LocationWhenInUse', :path => "../node_modules/react-native-permissions/ios/LocationWhenInUse"
  
  # Microphone permissions for audio
  pod 'Permission-Microphone', :path => "../node_modules/react-native-permissions/ios/Microphone"

  post_install do |installer|
    # React Native post install hooks
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )
    
    # Fix deployment targets for all pods
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
      end
    end
    
    # Disable code signing for resource bundles (Xcode 14+ compatibility)
    installer.target_installation_results.pod_target_installation_results
      .each do |pod_name, target_installation_result|
      target_installation_result.resource_bundle_targets.each do |resource_bundle_target|
        resource_bundle_target.build_configurations.each do |config|
          config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
        end
      end
    end
  end
end
